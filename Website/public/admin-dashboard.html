<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
</head>

<body>
    <div class="topnav">
        <table>
            <th><a href="index.html"><img id="logo" src="./Images/logo.png" alt="Holon Telecom Logo"></a></th>
            <th><button class="navButton" id="logout">Logout</button></th>
        </table>
    </div>

    <div class="client-wrapper">
        <h2>Client Management</h2>
        <input type="text" id="search-clients" placeholder="Search by name or email" />
        <button class="admin-actions">Add Client</button>
        <table id="clients-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Phone Number</th>
                    <th>Address</th>
                    <th>Email</th>
                    <th>Package</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dynamic rows populated here -->
            </tbody>
        </table>
    </div>

    <!-- Add Client Modal -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add Client</h2>
            <form id="addClientForm">
                <label for="firstName">First Name:</label>
                <input type="text" id="firstName" required>
                
                <label for="lastName">Last Name:</label>
                <input type="text" id="lastName" required>
                
                <label for="phoneNumber">Phone Number:</label>
                <input type="text" id="phoneNumber" required>
                
                <label for="address">Address (Optional):</label>
                <input type="text" id="address">
                
                <label for="email">Email:</label>
                <input type="email" id="email" required>
                
                <label for="packageName">Package (Optional):</label>
                <input type="text" id="packageName">
                
                <button type="submit" class="admin-actions">Submit</button>
            </form>
        </div>
    </div>

    <script>
        // Logout functionality
        document.getElementById('logout').addEventListener('click', function () {
            localStorage.removeItem('token');
            localStorage.removeItem('email');
            window.location.href = "login.html";
        });

        // Fetch clients from the database
        async function fetchClients() {
            const tableBody = document.querySelector('#clients-table tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            try {
                const response = await fetch('/api/clients');
                const clients = await response.json();

                clients.forEach(client => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${client.id}</td>
                        <td>${client.first_name}</td>
                        <td>${client.last_name}</td>
                        <td>${client.phone_number}</td>
                        <td>${client.address || 'N/A'}</td>
                        <td>${client.email}</td>
                        <td>${client.package || 'N/A'}</td>
                        <td>
                            <button class="admin-actions remove" data-id="${client.id_clients}">Remove</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.querySelectorAll('.remove').forEach(button => {
                    button.addEventListener('click', async function () {
                        const clientId = this.getAttribute('data-id');
                        if (confirm(`Are you sure you want to remove client with ID ${clientId}?`)) {
                            await deleteClient(clientId);
                            fetchClients();
                        }
                    });
                });
            } catch (error) {
                console.error('Error fetching clients:', error);
                alert('Failed to fetch clients. Please try again later.');
            }
        }

        // Delete client functionality
        async function deleteClient(clientId) {
            try {
                const response = await fetch(`/api/clients/${clientId}`, { method: 'DELETE' });
                if (!response.ok) {
                    if (response.status === 404) {
                        alert('Client not found!');
                        return;
                    }
                    throw new Error('Failed to delete client.');
                }
                const deletedClient = await response.json();
                alert(`Client Removed: ${deletedClient.first_name} ${deletedClient.last_name}`);
            } catch (error) {
                console.error('Error removing client:', error);
                alert('Failed to remove client. Please try again.');
            }
        }

        // Modal Controls
        const addClientModal = document.getElementById('addClientModal');
        const addClientButton = document.querySelector('.admin-actions:not(.remove)');
        const closeModalButton = document.querySelector('.close');
        const addClientForm = document.getElementById('addClientForm');

        // Open the modal
        addClientButton.addEventListener('click', () => {
            addClientModal.style.display = 'block';
        });

        // Close the modal
        closeModalButton.addEventListener('click', () => {
            addClientModal.style.display = 'none';
        });

        // Close modal on outside click
        window.addEventListener('click', (event) => {
            if (event.target === addClientModal) {
                addClientModal.style.display = 'none';
            }
        });

        // Handle form submission
        addClientForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const address = document.getElementById('address').value;
            const email = document.getElementById('email').value;
            const packageName = document.getElementById('packageName').value;

            try {
                const response = await fetch('/api/clients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        phone_number: phoneNumber,
                        address,
                        email,
                        package: packageName,
                    }),
                });

                const newClient = await response.json();
                alert(`Client Added: ${newClient.first_name} ${newClient.last_name}`);
                addClientModal.style.display = 'none';
                fetchClients();
            } catch (error) {
                console.error('Error adding client:', error);
                alert('Failed to add client. Please try again.');
            }
        });

        // Initial fetch
        fetchClients();
    </script>
</body>

</html>
